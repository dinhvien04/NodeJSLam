<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Ri√™ng</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <div class="container">
        <!-- User Selection Screen -->
        <div id="userSelection" class="private-chat-container">
            <div class="chat-header">
                <h2><i class="fas fa-comments"></i> Ch·ªçn ng∆∞·ªùi ƒë·ªÉ chat ri√™ng</h2>
                <button onclick="window.location.href='index.html'" class="back-btn">
                    <i class="fas fa-arrow-left"></i> Quay l·∫°i
                </button>
            </div>
            <div class="online-users-list" id="onlineUsersList">
                <!-- Users will be populated here -->
            </div>
        </div>

        <!-- Private Chat Screen -->
        <div id="privateChatScreen" class="private-chat-container" style="display: none;">
            <div class="chat-header">
                <button onclick="backToUserSelection()" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="chat-partner-info">
                    <div>
                        <i class="fas fa-user"></i>
                        <span id="chatPartnerName">Chat v·ªõi...</span>
                        <div id="userStatus" class="user-status online">ƒêang online</div>
                    </div>
                </div>
            </div>
            <div id="privateMessages" class="messages"></div>
            <div class="input-container" id="inputContainer">
                <button id="recordBtn" class="record-btn" type="button">
                    <i class="fas fa-microphone"></i>
                </button>
                <div class="emoji-picker" onclick="toggleEmojiPicker(event)">
                    <i class="far fa-smile"></i>
                    <div id="emojiMenu" class="emoji-menu" style="display: none;">
                        <div class="emoji-categories">
                            <div class="emoji-category active" onclick="showEmojiCategory('recent', this)"
                                title="G·∫ßn ƒë√¢y">üòä</div>
                            <div class="emoji-category" onclick="showEmojiCategory('smileys', this)" title="C·∫£m x√∫c">üòÄ
                            </div>
                            <div class="emoji-category" onclick="showEmojiCategory('people', this)" title="Con ng∆∞·ªùi">üëç
                            </div>
                            <div class="emoji-category" onclick="showEmojiCategory('animals', this)" title="ƒê·ªông v·∫≠t">üê∂
                            </div>
                            <div class="emoji-category" onclick="showEmojiCategory('food', this)" title="ƒê·ªì ƒÉn">üçé</div>
                            <div class="emoji-category" onclick="showEmojiCategory('travel', this)" title="Du l·ªãch">‚úàÔ∏è
                            </div>
                            <div class="emoji-category" onclick="showEmojiCategory('objects', this)" title="ƒê·ªì v·∫≠t">üí°
                            </div>
                            <div class="emoji-category" onclick="showEmojiCategory('symbols', this)" title="K√Ω hi·ªáu">‚ù§Ô∏è
                            </div>
                        </div>
                        <div class="emoji-category-title" id="emojiCategoryTitle">G·∫ßn ƒë√¢y</div>
                        <div class="emoji-grid" id="emojiGrid">
                            <!-- Emojis will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="file-attach" style="position: relative;">
                    <i class="fas fa-paperclip" onclick="toggleFileMenu(event)"></i>
                    <div id="fileMenu" class="file-menu" style="display: none;">
                        <div class="file-menu-item" onclick="triggerImageInput()">
                            <i class="fas fa-image"></i>
                            <span>G·ª≠i ·∫£nh</span>
                        </div>
                        <div class="file-menu-item" onclick="triggerFileInput()">
                            <i class="fas fa-file"></i>
                            <span>G·ª≠i file</span>
                        </div>
                    </div>
                    <input type="file" id="imageInput" style="display:none" accept="image/*" />
                    <input type="file" id="fileInput" style="display:none" />
                </div>
                <input type="text" id="privateMessageInput" placeholder="Nh·∫≠p tin nh·∫Øn ri√™ng...">
                <button onclick="sendPrivateMessage()" class="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <!-- Voice Recording UI (·∫©n m·∫∑c ƒë·ªãnh) -->
            <div class="voice-recording-ui" id="voiceRecordingUI"
                style="display:none; align-items:center; gap:10px; padding:8px 0;">
                <button id="cancelRecordBtn" class="record-btn" style="background:#1976d2;"><i
                        class="fas fa-times"></i></button>
                <button id="stopRecordBtn" class="record-btn"><i class="fas fa-stop"></i></button>
                <div class="voice-recording-bar" style="flex:1; display:flex; align-items:center;">
                    <span id="recordingTime"
                        style="color:#fff; font-weight:600; background:#2196f3; border-radius:12px; padding:4px 14px; min-width:48px; text-align:center;">0:00</span>
                </div>
                <button id="sendRecordBtn" class="record-btn" style="background:#2196f3; display:none;"><i
                        class="fas fa-paper-plane"></i></button>
            </div>

            <!-- Image Preview -->
            <div id="imagePreviewContainer" class="image-preview-container" style="display:none;">
                <img id="imagePreview" class="image-preview" src="" alt="Preview" />
                <div class="preview-btn-group">
                    <button onclick="sendImagePreview()" class="btn-login">G·ª≠i</button>
                    <button onclick="cancelImagePreview()" class="btn-register">H·ªßy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Sound -->
    <audio id="notificationSound" src="sounds/notification.mp3"></audio>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@emoji-mart/data"></script>
    <script src="js/ui.js"></script>
    <script src="js/private-chat.js"></script>
    <script src="https://unpkg.com/wavesurfer.js"></script>

    <script>
        // File upload functions
        function toggleFileMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('fileMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function triggerImageInput() {
            document.getElementById('imageInput').click();
            document.getElementById('fileMenu').style.display = 'none';
        }

        function triggerFileInput() {
            document.getElementById('fileInput').click();
            document.getElementById('fileMenu').style.display = 'none';
        }

        // Image upload handling
        document.getElementById('imageInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreviewContainer').style.display = 'block';
                    document.getElementById('inputContainer').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                uploadFile(file);
            }
        });

        function sendImagePreview() {
            const file = document.getElementById('imageInput').files[0];
            if (file) {
                uploadFile(file);
            }
        }

        function cancelImagePreview() {
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.getElementById('inputContainer').style.display = 'flex';
            document.getElementById('imageInput').value = '';
        }

        async function uploadFile(file) {
            if (!selectedUser) {
                alert('Vui l√≤ng ch·ªçn ng∆∞·ªùi ƒë·ªÉ chat tr∆∞·ªõc!');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getCookie('authToken')}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();

                    // Send file message
                    const fileType = file.type.startsWith('image/') ? 'image' :
                        file.type.startsWith('audio/') ? 'audio' : 'file';

                    const messageData = {
                        to: selectedUser.username,
                        from: currentUser.username,
                        content: result.filePath,
                        type: fileType,
                        fileName: file.name,
                        timestamp: new Date()
                    };

                    // Validate data before sending
                    if (!messageData.content || !messageData.to || !messageData.from) {
                        console.error('Invalid file message data:', messageData);
                        return;
                    }

                    // Display and send message
                    displayPrivateMessage(messageData, true);
                    socket.emit('private:message', messageData);

                    // Reset UI
                    cancelImagePreview();
                } else {
                    const errorText = await response.text();
                    console.error('Upload failed:', errorText);
                    alert(`Upload th·∫•t b·∫°i: ${errorText}`);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert(`L·ªói upload: ${error.message}`);
            }
        }

        // Voice recording
        let mediaRecorder;
        let audioChunks = [];
        let recordingTimer;
        let recordingStartTime;

        document.getElementById('recordBtn').addEventListener('click', startRecording);
        document.getElementById('stopRecordBtn').addEventListener('click', stopRecording);
        document.getElementById('cancelRecordBtn').addEventListener('click', cancelRecording);
        document.getElementById('sendRecordBtn').addEventListener('click', sendRecording);

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    // Handle audio blob here
                    document.getElementById('sendRecordBtn').style.display = 'block';
                };

                mediaRecorder.start();
                recordingStartTime = Date.now();

                // Show recording UI
                document.getElementById('inputContainer').style.display = 'none';
                document.getElementById('voiceRecordingUI').style.display = 'flex';

                // Start timer
                recordingTimer = setInterval(updateRecordingTime, 1000);
            } catch (error) {
                console.error('Recording error:', error);
                alert('Microphone access denied');
            }
        }

        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('recordingTime').textContent =
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                clearInterval(recordingTimer);
            }
        }

        function cancelRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }

            clearInterval(recordingTimer);
            audioChunks = [];

            // Reset UI
            document.getElementById('voiceRecordingUI').style.display = 'none';
            document.getElementById('inputContainer').style.display = 'flex';
            document.getElementById('sendRecordBtn').style.display = 'none';
        }

        async function sendRecording() {
            if (audioChunks.length > 0) {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const file = new File([audioBlob], 'voice_message.wav', { type: 'audio/wav' });

                await uploadFile(file);
                cancelRecording();
            }
        }

        // Emoji data
        const emojiData = {
            recent: ['üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üî•', 'üíØ', 'üòç', 'ü§î', 'üò≠', 'üéâ', 'üöÄ', '‚ú®'],
            smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï'],
            people: ['üëç', 'üëé', 'üëå', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëè', 'üôå', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è', 'üí™', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ', 'üíã'],
            animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'üê•', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü¶ü', 'ü¶ó', 'üï∑Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 'üêè', 'üêë', 'ü¶ô', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üêà', 'üêì', 'ü¶É', 'ü¶ö', 'ü¶ú', 'ü¶¢', 'ü¶©', 'üïäÔ∏è', 'üêá', 'ü¶ù', 'ü¶®', 'ü¶°', 'ü¶¶', 'ü¶•', 'üêÅ', 'üêÄ', 'üêøÔ∏è'],
            food: ['üçé', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'üåΩ', 'ü•ï', 'ü´í', 'üßÑ', 'üßÖ', 'ü•î', 'üç†', 'ü•ê', 'ü•Ø', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥', 'üßà', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'ü¶¥', 'üå≠', 'üçî', 'üçü', 'üçï'],
            travel: ['‚úàÔ∏è', 'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üõª', 'üöö', 'üöõ', 'üöú', 'üèçÔ∏è', 'üõµ', 'üö≤', 'üõ¥', 'üõπ', 'üõº', 'üöÅ', 'üõ∏', 'üöÄ', 'üõ©Ô∏è', 'üõ´', 'üõ¨', 'ü™Ç', '‚õµ', 'üö§', 'üõ•Ô∏è', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üö¢', '‚öì', '‚õΩ', 'üöß', 'üö•', 'üö¶', 'üó∫Ô∏è', 'üóø', 'üóΩ', 'üóº', 'üè∞', 'üèØ', 'üèüÔ∏è', 'üé°', 'üé¢', 'üé†', '‚õ±Ô∏è', 'üèñÔ∏è', 'üèùÔ∏è'],
            objects: ['üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'üß∞', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'üî©', '‚öôÔ∏è', 'üß±', '‚õìÔ∏è', 'üß≤', 'üî´', 'üí£', 'üß®', 'ü™ì', 'üî™', 'üó°Ô∏è', '‚öîÔ∏è', 'üõ°Ô∏è', 'üö¨', '‚ö∞Ô∏è', '‚ö±Ô∏è', 'üè∫', 'üîÆ', 'üìø', 'üßø', 'üíà', '‚öóÔ∏è', 'üî≠', 'üî¨', 'üï≥Ô∏è', 'ü©π', 'ü©∫', 'üíä', 'üíâ'],
            symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üõó', 'üà≥', 'üàÇÔ∏è', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', '‚öß', 'üöª', 'üöÆ', 'üé¶', 'üì∂', 'üàÅ', 'üî£', '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†', 'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü']
        };

        let currentEmojiCategory = 'recent';

        // Toggle emoji picker
        function toggleEmojiPicker(event) {
            // Prevent event bubbling
            if (event) {
                event.stopPropagation();
            }

            const menu = document.getElementById('emojiMenu');
            const isVisible = menu.style.display !== 'none';

            if (isVisible) {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
                showEmojiCategory(currentEmojiCategory);
            }
        }

        // Show emoji category
        function showEmojiCategory(category, element) {
            // Prevent event bubbling
            if (event) {
                event.stopPropagation();
            }

            currentEmojiCategory = category;

            // Update active category
            document.querySelectorAll('.emoji-category').forEach(cat => cat.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            } else {
                // Find the category element by data or content
                document.querySelectorAll('.emoji-category').forEach(cat => {
                    if (cat.textContent.includes(getCategoryIcon(category))) {
                        cat.classList.add('active');
                    }
                });
            }

            // Update category title
            const categoryNames = {
                'recent': 'G·∫ßn ƒë√¢y',
                'smileys': 'C·∫£m x√∫c',
                'people': 'Con ng∆∞·ªùi',
                'animals': 'ƒê·ªông v·∫≠t',
                'food': 'ƒê·ªì ƒÉn',
                'travel': 'Du l·ªãch',
                'objects': 'ƒê·ªì v·∫≠t',
                'symbols': 'K√Ω hi·ªáu'
            };
            document.getElementById('emojiCategoryTitle').textContent = categoryNames[category] || 'Emoji';

            // Show emojis
            const grid = document.getElementById('emojiGrid');
            const emojis = emojiData[category] || [];

            grid.innerHTML = emojis.map(emoji =>
                `<div class="emoji-item" onclick="insertEmoji('${emoji}', event)">${emoji}</div>`
            ).join('');
        }

        // Get category icon
        function getCategoryIcon(category) {
            const icons = {
                'recent': 'üòä',
                'smileys': 'üòÄ',
                'people': 'üëç',
                'animals': 'üê∂',
                'food': 'üçé',
                'travel': '‚úàÔ∏è',
                'objects': 'üí°',
                'symbols': '‚ù§Ô∏è'
            };
            return icons[category] || 'üòä';
        }

        // Insert emoji into input
        function insertEmoji(emoji, event) {
            // Prevent event bubbling
            if (event) {
                event.stopPropagation();
            }

            const input = document.getElementById('privateMessageInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;

            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.focus();
            input.setSelectionRange(start + emoji.length, start + emoji.length);

            // Hide emoji picker
            document.getElementById('emojiMenu').style.display = 'none';

            // Add to recent if not already there
            if (!emojiData.recent.includes(emoji)) {
                emojiData.recent.unshift(emoji);
                if (emojiData.recent.length > 12) {
                    emojiData.recent.pop();
                }
            }
        }

        // Close menus when clicking outside
        document.addEventListener('click', function (e) {
            // Close file menu
            if (!e.target.closest('.file-attach')) {
                document.getElementById('fileMenu').style.display = 'none';
            }

            // Close emoji menu (but not when clicking inside the menu)
            if (!e.target.closest('.emoji-picker') && !e.target.closest('#emojiMenu')) {
                document.getElementById('emojiMenu').style.display = 'none';
            }
        });

        // Prevent emoji menu from closing when clicking inside it
        document.addEventListener('DOMContentLoaded', function () {
            const emojiMenu = document.getElementById('emojiMenu');
            if (emojiMenu) {
                emojiMenu.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            }
        });
    </script>

    <style>
        .private-chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            margin: 20px auto;
        }

        .chat-header {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            padding: 16px;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .chat-partner-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .online-users-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-item:hover {
            background: var(--hover-color);
            border-color: #4caf50;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4caf50;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 12px;
            position: relative;
        }

        .user-avatar.offline {
            background: #999;
        }

        .user-avatar.online::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #4caf50;
            border: 2px solid white;
            border-radius: 50%;
        }

        .user-avatar.offline::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #999;
            border: 2px solid white;
            border-radius: 50%;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .user-status {
            font-size: 0.85em;
            color: #4caf50;
        }

        .user-status.online {
            color: #4caf50;
        }

        .user-status.offline {
            color: #ff6b6b;
        }

        .chat-partner-info .user-status {
            font-size: 0.75em;
            margin-top: 2px;
        }

        .private-message {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .private-message.sent {
            background: #4caf50;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .private-message.received {
            background: var(--message-bg);
            color: var(--text-color);
            align-self: flex-start;
        }

        .message-wrapper {
            position: relative;
            width: 100%;
        }

        .message-actions {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 4px;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .edit-btn,
        .delete-btn {
            background: transparent;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 12px;
            transition: background 0.2s;
        }

        .edit-btn:hover {
            background: #2196f3;
            color: white;
        }

        .delete-btn:hover {
            background: #f44336;
            color: white;
        }

        .edited-indicator {
            font-size: 0.7em;
            opacity: 0.7;
            font-style: italic;
        }

        .message-content {
            cursor: pointer;
        }

        .message-content:hover {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            padding: 2px 4px;
            margin: -2px -4px;
        }

        .message-time {
            font-size: 0.75em;
            opacity: 0.7;
            margin-top: 4px;
        }

        .record-btn {
            background: #f44336;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .record-btn:hover {
            background: #d32f2f;
        }

        .emoji-picker {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-color);
            border-radius: 50%;
            transition: background 0.2s;
            position: relative;
        }

        .emoji-picker:hover {
            background: var(--hover-color);
        }

        .emoji-menu {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            width: 320px;
            height: 380px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .emoji-categories {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            padding: 10px 8px 8px 8px;
            gap: 6px;
            background: rgba(255, 255, 255, 0.05);
            overflow-x: auto;
        }

        .emoji-category-title {
            padding: 8px 15px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.02);
        }

        .emoji-category {
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            background: transparent;
            border: 2px solid transparent;
        }

        .emoji-category:hover {
            background: var(--hover-color);
            transform: scale(1.1);
        }

        .emoji-category.active {
            background: #4caf50;
            border-color: #4caf50;
            transform: scale(1.1);
        }

        .emoji-grid {
            padding: 15px;
            height: 270px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
        }

        .emoji-grid::-webkit-scrollbar {
            width: 6px;
        }

        .emoji-grid::-webkit-scrollbar-track {
            background: transparent;
        }

        .emoji-grid::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .emoji-item {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 20px;
        }

        .emoji-item:hover {
            background: var(--hover-color);
            transform: scale(1.2);
        }

        .file-attach {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-color);
            border-radius: 50%;
            transition: background 0.2s;
        }

        .file-attach:hover {
            background: var(--hover-color);
        }

        .file-menu {
            position: absolute;
            bottom: 45px;
            left: 0;
            z-index: 10;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            min-width: 140px;
        }

        .file-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-color);
        }

        .file-menu-item:hover {
            background: var(--hover-color);
        }

        .file-menu-item i {
            width: 16px;
            font-size: 14px;
            color: #4caf50;
        }

        .file-menu-item span {
            font-weight: 500;
        }

        .voice-recording-ui {
            padding: 12px;
            background: var(--card-background);
            border-top: 1px solid var(--border-color);
        }

        .image-preview-container {
            padding: 20px;
            background: var(--card-background);
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .preview-btn-group {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-login,
        .btn-register {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-login {
            background: #4caf50;
            color: white;
        }

        .btn-register {
            background: #f44336;
            color: white;
        }
    </style>
</body>

</html>